name: Train a model

on:
  workflow_dispatch:
    inputs:
      model-name:
        required: true
        description: The name of the Replicate model to publish, in the format `your-replicate-username/desired-model-name`.
      prompt-identifier:
        required: true
        description: A short string like `zxz` representing your custom concept for prompts.
        default: zxz
      max-train-steps:
        required: true
        description: Number of training steps (e.g. 2000).
        type: number
        default: 2000

env:
  replicate-api-token: ${{ secrets.REPLICATE_API_TOKEN }}

jobs:
  train:
    runs-on: ubuntu-latest
    steps:

      - name: Check secrets
        if: ${{ env.replicate-api-token == '' }}
        run: |
          echo "‚ùå Missing REPLICATE_API_TOKEN secret!"
          exit 1
      
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Zip training data
        run: |
          zip -r data.zip data

      - name: Upload training data
        id: upload-training-data
        run: |
          echo "üîÅ –ü–æ–ª—É—á–∞–µ–º URL –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏..."
          RESPONSE=$(curl -s -X POST -H "Authorization: Token ${{ secrets.REPLICATE_API_TOKEN }}" https://dreambooth-api-experimental.replicate.com/v1/upload)
          
          echo "üì¶ –û—Ç–≤–µ—Ç –æ—Ç Replicate:"
          echo "$RESPONSE"
          
          UPLOAD_URL=$(echo "$RESPONSE" | jq -r ".upload_url")
          SERVING_URL=$(echo "$RESPONSE" | jq -r ".serving_url")

          if [ -z "$UPLOAD_URL" ] || [ -z "$SERVING_URL" ]; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å upload_url –∏–ª–∏ serving_url. –ü—Ä–µ–∫—Ä–∞—â–∞—é —Ä–∞–±–æ—Ç—É."
            exit 1
          fi

          echo "üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º zip..."
          curl -X PUT -H "Content-Type: application/zip" --upload-file data.zip "$UPLOAD_URL"

          echo "INSTANCE_DATA_URL=$SERVING_URL" >> $GITHUB_ENV
          echo "INSTANCE_DATA_URL=$SERVING_URL" >> $GITHUB_OUTPUT

      - name: Start training
        run: |
          echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏..."
          curl -s -X POST \
          -H "Authorization: Token ${{ secrets.REPLICATE_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
                "input": {
                    "instance_prompt": "a photo of a ${{ inputs.prompt-identifier }} person",
                    "class_prompt": "a photo of a person",
                    "instance_data": "'"${{ env.INSTANCE_DATA_URL }}"'",
                    "max_train_steps": ${{ inputs.max-train-steps }}
                },
                "model": "${{ inputs.model-name }}",
                "trainer_version": "cd3f925f7ab21afaef7d45224790eedbb837eeac40d22e8fefe015489ab644aa"
              }' \
          https://dreambooth-api-experimental.replicate.com/v1/trainings

      - name: Link to model
        run: |
          echo "üöÇ –ú–æ–¥–µ–ª—å –æ–±—É—á–∞–µ—Ç—Å—è!"
          echo "–ü–µ—Ä–µ–π–¥–∏ –Ω–∞ https://replicate.com/${{ inputs.model-name }} —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å."
